<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>報價管理系統 - 互動原型</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 簡單的淡入動畫 */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Modal 開啟時，禁止背景滾動 */
        body.modal-open {
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div id="app" class="flex h-screen">
        </div>

    <div id="modal-container" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        </div>

<script>
// --- 1. 資料模型 (Data Model) ---
const db = {
    suppliers: [
        { id: 'sup-1', name: '肉肉安心購', phone: '02-1234-5678', mail: 'service@dachan.com' },
        { id: 'sup-2', name: '健仔食品', phone: '02-8765-4321', mail: 'contact@cpe.com.tw' }
    ],
    buyers: [
        { id: 'buy-1', name: '城市超市', phone: '0800-885-889', mail: 'procurement@citysuper.com.tw', accountManager: '王經理' },
        { id: 'buy-2', name: '頂級生鮮', phone: '0809-068-888', mail: 'buyer@topfresh.com', accountManager: '李協理' }
    ],
    products: [
        { id: 'prod-1', name: 'CAS產銷履歷雞胸肉', categoryId: 'cat-1', partId: 'part-1', specId: 'spec-1', packagingId: 'pack-1' },
        { id: 'prod-2', name: 'A級帶骨雞腿塊', categoryId: 'cat-1', partId: 'part-2', specId: 'spec-2', packagingId: 'pack-2' },
        { id: 'prod-3', name: 'M9+和牛紐約客', categoryId: 'cat-2', partId: 'part-3', specId: 'spec-3', packagingId: 'pack-3' }
    ],
    productCategories: [
        { id: 'cat-1', name: '家禽類' },
        { id: 'cat-2', name: '牛肉類' }
    ],
    productParts: [
        { id: 'part-1', name: '雞胸', categoryId: 'cat-1' },
        { id: 'part-2', name: '雞腿', categoryId: 'cat-1' },
        { id: 'part-3', name: '紐約客', categoryId: 'cat-2' }
    ],
    productSpecs: [
        { id: 'spec-1', name: '2kg/包', categoryId: 'cat-1' },
        { id: 'spec-2', name: '10kg/箱', categoryId: 'cat-1' },
        { id: 'spec-3', name: '200g/片', categoryId: 'cat-2' },
    ],
    productPackagings: [
        { id: 'pack-1', name: '真空貼體包', categoryId: 'cat-1' },
        { id: 'pack-2', name: '散裝箱', categoryId: 'cat-1' },
        { id: 'pack-3', name: '單片真空包', categoryId: 'cat-2' }
    ],
    supplierQuotes: [
        { id: 'sq-1', productId: 'prod-1', supplierId: 'sup-1', cost: 150, date: '2025-06-01T10:00:00Z' },
        { id: 'sq-2', productId: 'prod-1', supplierId: 'sup-2', cost: 155, date: '2025-06-05T11:00:00Z' },
        { id: 'sq-3', productId: 'prod-2', supplierId: 'sup-1', cost: 120, date: '2025-06-03T09:00:00Z' },
        { id: 'sq-4', productId: 'prod-3', supplierId: 'sup-1', cost: 800, date: '2025-06-08T14:00:00Z' },
    ],
    quotesToBuyers: [
        { id: 'qb-1', supplierQuoteId: 'sq-2', buyerId: 'buy-1', price: 180, date: '2025-06-06T14:00:00Z' },
        { id: 'qb-2', supplierQuoteId: 'sq-2', buyerId: 'buy-2', price: 182, date: '2025-06-06T15:00:00Z' },
        { id: 'qb-3', supplierQuoteId: 'sq-1', buyerId: 'buy-1', price: 175, date: '2025-06-02T16:00:00Z' },
        { id: 'qb-4', supplierQuoteId: 'sq-4', buyerId: 'buy-2', price: 950, date: '2025-06-09T10:00:00Z' },
    ]
};

// --- 2. 應用程式狀態管理 (State Management) ---
const state = {
    currentPage: 'suppliers', // 'suppliers', 'buyers', 'products', 'attributes', 'productDetail', 'buyerDetail'
    selectedId: null, // 用於詳情頁，可以是 productId 或 buyerId
    attributeTab: 'productCategories', // 'productCategories', 'productParts', ...
    buyerDetailSelectedProductId: null, // 購買者詳情頁中選擇的產品
};

// --- 3. DOM 節點與輔助函式 ---
const appContainer = document.getElementById('app');
const modalContainer = document.getElementById('modal-container');

// 輔助函式：將 ISO 日期字串格式化為台灣本地時間
const formatDateTime = (isoString) => isoString ? new Date(isoString).toLocaleString('zh-TW', { timeZone: "Asia/Taipei", year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute:'2-digit' }) : 'N/A';
// 輔助函式：從集合中查找名稱
const findNameById = (collection, id) => db[collection]?.find(i => i.id === id)?.name || 'N/A';
// 輔助函式：產生唯一 ID
const generateId = (prefix) => `${prefix}-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;


// --- 4. 核心渲染函式 (Rendering Functions) ---

/**
 * 主渲染函式，根據 state 決定顯示內容
 */
function render() {
    const contentRenderers = {
        suppliers: renderListPage,
        buyers: renderListPage,
        products: renderListPage,
        attributes: renderAttributesPage,
        productDetail: renderProductDetail,
        buyerDetail: renderBuyerDetail,
    };
    
    const sidebarHtml = renderSidebar();
    const contentHtml = contentRenderers[state.currentPage] ? contentRenderers[state.currentPage]() : `<div>頁面未找到</div>`;

    appContainer.innerHTML = `
        ${sidebarHtml}
        <main class="flex-1 p-6 md:p-8 overflow-y-auto">
            <div class="fade-in">
                ${contentHtml}
            </div>
        </main>
    `;
    addEventListeners();
}

/**
 * 渲染左側固定導航欄
 */
function renderSidebar() {
    const navItems = [
        { key: 'suppliers', name: '供應商管理' },
        { key: 'buyers', name: '購買者管理' },
        { key: 'products', name: '產品管理' },
        { key: 'attributes', name: '產品屬性設定' },
    ];
    const isDetailView = ['productDetail', 'buyerDetail'].includes(state.currentPage);

    return `
        <nav class="w-64 bg-white shadow-md flex-shrink-0 flex flex-col">
            <div class="p-4 border-b">
                <h1 class="text-xl md:text-2xl font-bold text-gray-800">報價管理系統</h1>
            </div>
            <ul class="flex-grow">
                ${navItems.map(item => `
                    <li>
                        <a href="#" data-action="navigate" data-page="${item.key}" class="block p-4 text-gray-700 hover:bg-indigo-500 hover:text-white transition-colors duration-200 ${!isDetailView && state.currentPage === item.key ? 'bg-indigo-600 text-white font-bold' : ''}">
                            ${item.name}
                        </a>
                    </li>
                `).join('')}
            </ul>
        </nav>
    `;
}

/**
 * 渲染通用的列表頁面 (供應商、購買者、產品)
 */
function renderListPage() {
    const pageConfig = {
        suppliers: { title: '供應商管理', data: db.suppliers, headers: ['名稱', '電話', 'Email'], fields: ['name', 'phone', 'mail'] },
        buyers: { title: '購買者管理', data: db.buyers, headers: ['名稱', '電話', 'Email', '負責業務'], fields: ['name', 'phone', 'mail', 'accountManager'] },
        products: { title: '產品管理', data: db.products, headers: ['名稱', '種類', '部位', '規格'], fields: ['name', 'categoryId', 'partId', 'specId'] }
    };
    const config = pageConfig[state.currentPage];

    const getFieldValue = (item, field) => {
        if (field === 'categoryId') return findNameById('productCategories', item.categoryId);
        if (field === 'partId') return findNameById('productParts', item.partId);
        if (field === 'specId') return findNameById('productSpecs', item.specId);
        return item[field];
    };
    
    return `
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold text-gray-800">${config.title}</h2>
            <button data-action="show-add-modal" data-type="${state.currentPage}" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition shadow-sm">
                新增
            </button>
        </div>
        <div class="bg-white shadow-lg rounded-lg overflow-x-auto">
            <table class="min-w-full">
                <thead class="bg-gray-200">
                    <tr>${config.headers.map(h => `<th class="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">${h}</th>`).join('')}</tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    ${config.data.map(item => `
                        <tr class="hover:bg-gray-50 cursor-pointer" data-action="view-detail" data-type="${state.currentPage}" data-id="${item.id}">
                            ${config.fields.map(field => `<td class="py-3 px-4 whitespace-nowrap">${getFieldValue(item, field)}</td>`).join('')}
                        </tr>
                    `).join('') || `<tr><td colspan="${config.headers.length}" class="p-4 text-center text-gray-500">沒有資料</td></tr>`}
                </tbody>
            </table>
        </div>
    `;
}

/**
 * 渲染產品屬性設定頁面
 */
function renderAttributesPage() {
    const tabs = [
        { key: 'productCategories', name: '產品種類', headers: ['種類名稱'], fields: ['name'] },
        { key: 'productParts', name: '部位', headers: ['部位名稱', '隸屬種類'], fields: ['name', 'categoryId'] },
        { key: 'productSpecs', name: '規格', headers: ['規格名稱', '隸屬種類'], fields: ['name', 'categoryId'] },
        { key: 'productPackagings', name: '包裝方式', headers: ['包裝名稱', '隸屬種類'], fields: ['name', 'categoryId'] },
    ];
    const activeTabConfig = tabs.find(t => t.key === state.attributeTab);
    const data = db[activeTabConfig.key];
    
    return `
        <h2 class="text-3xl font-bold text-gray-800 mb-6">產品屬性設定</h2>
        <div class="flex border-b mb-6">
            ${tabs.map(tab => `
                <button data-action="switch-attribute-tab" data-tab="${tab.key}" class="py-2 px-4 font-semibold -mb-px border-b-2 ${state.attributeTab === tab.key ? 'text-indigo-600 border-indigo-600' : 'text-gray-500 border-transparent hover:text-indigo-600'}">
                    ${tab.name}
                </button>
            `).join('')}
        </div>
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-700">${activeTabConfig.name}列表</h3>
            <button data-action="show-add-modal" data-type="${state.attributeTab}" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">
                新增${activeTabConfig.name}
            </button>
        </div>
        <div class="bg-white shadow-lg rounded-lg overflow-hidden">
            <table class="min-w-full">
                 <thead class="bg-gray-200">
                    <tr>${activeTabConfig.headers.map(h => `<th class="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase">${h}</th>`).join('')}</tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    ${data.map(item => `
                        <tr>
                            ${activeTabConfig.fields.map(field => `<td class="py-3 px-4">${field === 'categoryId' ? findNameById('productCategories', item[field]) : item[field]}</td>`).join('')}
                        </tr>
                    `).join('') || `<tr><td colspan="${activeTabConfig.headers.length}" class="p-4 text-center text-gray-500">沒有資料</td></tr>`}
                </tbody>
            </table>
        </div>
    `;
}

/**
 * 渲染產品詳情頁
 */
function renderProductDetail() {
    const product = db.products.find(p => p.id === state.selectedId);
    if (!product) return '<div>產品不存在</div>';

    const allSupplierQuotes = db.supplierQuotes.filter(sq => sq.productId === product.id).sort((a, b) => new Date(b.date) - new Date(a.date));
    const latestQuote = allSupplierQuotes[0] || null;
    const quotesForLatestCost = latestQuote ? db.quotesToBuyers.filter(qb => qb.supplierQuoteId === latestQuote.id) : [];
        
    return `
        <div class="space-y-8">
            <div>
                <div class="flex justify-between items-baseline gap-4">
                    <h2 class="text-3xl font-bold text-gray-800">${product.name}</h2>
                    <button data-action="show-add-modal" data-type="supplierQuote" data-product-id="${product.id}" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 flex-shrink-0">新增成本</button>
                </div>
                <div class="mt-2 text-gray-600 grid grid-cols-2 md:grid-cols-4 gap-4 bg-white p-4 rounded-lg shadow-sm">
                    <p><strong>種類:</strong> ${findNameById('productCategories', product.categoryId)}</p>
                    <p><strong>部位:</strong> ${findNameById('productParts', product.partId)}</p>
                    <p><strong>規格:</strong> ${findNameById('productSpecs', product.specId)}</p>
                    <p><strong>包裝:</strong> ${findNameById('productPackagings', product.packagingId)}</p>
                </div>
            </div>

            ${latestQuote ? `
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center border-b pb-4 mb-4 flex-wrap gap-4">
                    <div>
                        <h3 class="text-xl font-bold text-indigo-700">最新成本價</h3>
                        <p class="text-3xl font-bold text-gray-900">$${latestQuote.cost}</p>
                        <p class="text-sm text-gray-500">由 ${findNameById('suppliers', latestQuote.supplierId)} 於 ${formatDateTime(latestQuote.date)} 提供</p>
                    </div>
                    <button data-action="show-add-modal" data-type="quoteToBuyer" data-supplier-quote-id="${latestQuote.id}" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600">新增出價</button>
                </div>
                <h4 class="text-lg font-semibold text-gray-800 mb-2">此成本對應的出價列表</h4>
                <ul class="divide-y divide-gray-200">
                    ${quotesForLatestCost.length > 0 ? quotesForLatestCost.map(q => `
                        <li class="py-2 flex justify-between items-center">
                            <div>
                                <p class="font-semibold">${findNameById('buyers', q.buyerId)}</p>
                                <p class="text-sm text-gray-500">出價時間: ${formatDateTime(q.date)}</p>
                            </div>
                            <p class="text-lg font-bold text-green-600">$${q.price}</p>
                        </li>
                    `).join('') : '<li class="py-2 text-gray-500">尚無出價</li>'}
                </ul>
            </div>
            ` : '<div class="bg-white p-6 rounded-lg shadow-lg text-gray-500 text-center">此產品尚無任何成本報價。</div>'}

            <div>
                <h3 class="text-2xl font-bold text-gray-800 mb-4">成本歷史列表</h3>
                <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                    <table class="min-w-full"><thead class="bg-gray-200"><tr><th class="py-3 px-4 text-left">報價時間</th><th class="py-3 px-4 text-left">供應商</th><th class="py-3 px-4 text-left">成本價</th></tr></thead>
                        <tbody class="divide-y divide-gray-200">
                             ${allSupplierQuotes.length > 0 ? allSupplierQuotes.map(q => `
                                <tr class="${q.id === latestQuote?.id ? 'bg-indigo-50 font-bold' : ''}">
                                    <td class="py-3 px-4">${formatDateTime(q.date)}</td>
                                    <td class="py-3 px-4">${findNameById('suppliers', q.supplierId)}</td>
                                    <td class="py-3 px-4">$${q.cost}</td>
                                </tr>
                            `).join('') : '<tr><td colspan="3" class="p-4 text-center text-gray-500">沒有歷史成本</td></tr>'}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}

/**
 * 渲染購買者詳情頁
 */
function renderBuyerDetail() {
    const buyer = db.buyers.find(b => b.id === state.selectedId);
    if (!buyer) return '<div>購買者不存在</div>';

    const productIdsQuoted = [...new Set(db.quotesToBuyers.filter(qb => qb.buyerId === buyer.id).map(qb => db.supplierQuotes.find(s => s.id === qb.supplierQuoteId)?.productId).filter(Boolean))];
    const quotedProducts = db.products.filter(p => productIdsQuoted.includes(p.id));

    return `
        <h2 class="text-3xl font-bold text-gray-800 mb-6">購買者詳情: ${buyer.name}</h2>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 h-[calc(100vh-12rem)]">
            <div class="lg:col-span-1 bg-white p-4 rounded-lg shadow-lg overflow-y-auto">
                <h3 class="text-xl font-bold text-gray-800 border-b pb-2 mb-2">曾報價產品列表</h3>
                <ul class="divide-y divide-gray-200">
                    ${quotedProducts.map(p => `
                        <li data-action="select-buyer-product" data-product-id="${p.id}" class="p-3 cursor-pointer hover:bg-indigo-100 rounded-md ${p.id === state.buyerDetailSelectedProductId ? 'bg-indigo-100 font-bold' : ''}">
                            ${p.name}
                        </li>
                    `).join('') || `<li class="p-3 text-gray-500">尚無報價產品</li>`}
                </ul>
            </div>
            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-lg overflow-y-auto">
                ${renderBuyerDetailRightPanel()}
            </div>
        </div>
    `;
}

/**
 * 渲染購買者詳情頁的右側面板
 */
function renderBuyerDetailRightPanel() {
    if (!state.buyerDetailSelectedProductId) {
        return `<div class="flex items-center justify-center h-full text-gray-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>請從左側選擇產品</div>`;
    }
    const product = db.products.find(p => p.id === state.buyerDetailSelectedProductId);
    const latestSupplierQuote = db.supplierQuotes.filter(sq => sq.productId === product.id).sort((a, b) => new Date(b.date) - new Date(a.date))[0];

    if (!latestSupplierQuote) {
        return `<div class="text-gray-500">此產品 (${product.name}) 尚無參考成本。</div>`;
    }

    const quotesForLatestCost = db.quotesToBuyers.filter(qb => qb.supplierQuoteId === latestSupplierQuote.id && qb.buyerId === state.selectedId);
    const allHistoricalQuotes = db.quotesToBuyers.filter(qb => db.supplierQuotes.find(s => s.id === qb.supplierQuoteId)?.productId === product.id && qb.buyerId === state.selectedId).sort((a, b) => new Date(b.date) - new Date(a.date));

    return `
        <div class="space-y-6 fade-in">
            <div class="flex justify-between items-baseline"><h3 class="text-2xl font-bold text-gray-800">${product.name}</h3><button data-action="show-add-modal" data-type="quoteToBuyer" data-supplier-quote-id="${latestSupplierQuote.id}" data-buyer-id="${state.selectedId}" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600">建立新報價</button></div>
            <div class="bg-gray-50 p-4 rounded-lg"><h4 class="font-semibold text-gray-600">當前參考成本 (來自 ${findNameById('suppliers', latestSupplierQuote.supplierId)})</h4><p class="text-2xl font-bold text-indigo-700">$${latestSupplierQuote.cost}</p></div>
            <div><h4 class="text-lg font-semibold text-gray-700 mb-2">對當前成本的出價紀錄</h4><ul class="divide-y divide-gray-100 bg-white p-3 rounded-md border">${quotesForLatestCost.length > 0 ? quotesForLatestCost.map(q => `<li class="py-2 flex justify-between"><span>出價時間: ${formatDateTime(q.date)}</span><span class="font-bold text-green-600 text-lg">$${q.price}</span></li>`).join('') : '<li class="text-gray-500 py-2">尚無出價</li>'}</ul></div>
            <div><h4 class="text-lg font-semibold text-gray-700 mb-2">所有歷史報價</h4><div class="max-h-60 overflow-y-auto border rounded-md"><table class="min-w-full text-sm"><thead class="bg-gray-200 sticky top-0"><tr><th class="p-2 text-left">報價時間</th><th class="p-2 text-left">出價</th><th class="p-2 text-left">當時成本</th></tr></thead><tbody class="divide-y divide-gray-200">${allHistoricalQuotes.map(q => {const sq = db.supplierQuotes.find(s => s.id === q.supplierQuoteId); return `<tr class="hover:bg-gray-50 ${q.supplierQuoteId === latestSupplierQuote.id ? 'bg-indigo-50' : ''}"><td class="p-2">${formatDateTime(q.date)}</td><td class="p-2 font-bold">$${q.price}</td><td class="p-2 text-gray-600">$${sq.cost}</td></tr>`;}).join('')}</tbody></table></div></div>
        </div>
    `;
}

// --- 5. Modal 彈出視窗相關函式 ---

/**
 * 顯示 Modal，並根據類型產生內容
 */
function showModal(type, options = {}) {
    const titleMap = {
        suppliers: '新增供應商', buyers: '新增購買者', products: '新增產品', productCategories: '新增產品種類', productParts: '新增部位', productSpecs: '新增規格', productPackagings: '新增包裝方式', supplierQuote: '新增成本報價', quoteToBuyer: '新增客戶出價'
    };
    modalContainer.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-auto fade-in" id="modal-content">
            <div class="p-6 border-b"><h3 class="text-2xl font-bold text-gray-800">${titleMap[type] || '新增項目'}</h3></div>
            <form id="modal-form" data-type="${type}" class="p-6 space-y-4">
                ${getModalFormContent(type, options)}
                <div class="flex justify-end pt-4"><button type="button" data-action="close-modal" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg mr-2 hover:bg-gray-300">取消</button><button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">儲存</button></div>
            </form>
        </div>`;
    modalContainer.classList.remove('hidden');
    document.body.classList.add('modal-open');
}

/**
 * 根據類型產生 Modal 表單的 HTML
 */
function getModalFormContent(type, options) {
    const { productId, supplierQuoteId, buyerId } = options;
    const inputClass = "w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500";
    const labelClass = "block text-sm font-medium text-gray-700 mb-1";
    
    // 預設日期時間為當前
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    const nowString = now.toISOString().slice(0,16);

    const categoryDropdown = () => `<div><label for="categoryId" class="${labelClass}">隸屬產品種類</label><select id="categoryId" name="categoryId" class="${inputClass}" required>${db.productCategories.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}</select></div>`;
    
    let content = '';
    switch (type) {
        case 'suppliers': content = `<div><label class="${labelClass}">名稱</label><input name="name" class="${inputClass}" required></div><div><label class="${labelClass}">電話</label><input name="phone" type="tel" class="${inputClass}"></div><div><label class="${labelClass}">Email</label><input name="mail" type="email" class="${inputClass}"></div>`; break;
        case 'buyers': content = `<div><label class="${labelClass}">名稱</label><input name="name" class="${inputClass}" required></div><div><label class="${labelClass}">電話</label><input name="phone" type="tel" class="${inputClass}"></div><div><label class="${labelClass}">Email</label><input name="mail" type="email" class="${inputClass}"></div><div><label class="${labelClass}">負責業務</label><input name="accountManager" class="${inputClass}"></div>`; break;
        case 'products': content = `<div><label class="${labelClass}">名稱</label><input name="name" class="${inputClass}" required></div><div><label class="${labelClass}">產品種類</label><select name="categoryId" class="${inputClass}">${db.productCategories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}</select></div><div><label class="${labelClass}">部位</label><select name="partId" class="${inputClass}">${db.productParts.map(p=>`<option value="${p.id}">${p.name}</option>`).join('')}</select></div><div><label class="${labelClass}">規格</label><select name="specId" class="${inputClass}">${db.productSpecs.map(s=>`<option value="${s.id}">${s.name}</option>`).join('')}</select></div><div><label class="${labelClass}">包裝方式</label><select name="packagingId" class="${inputClass}">${db.productPackagings.map(p=>`<option value="${p.id}">${p.name}</option>`).join('')}</select></div>`; break;
        case 'productCategories': content = `<div><label class="${labelClass}">種類名稱</label><input name="name" class="${inputClass}" required></div>`; break;
        case 'productParts': content = `<div><label class="${labelClass}">部位名稱</label><input name="name" class="${inputClass}" required></div>${categoryDropdown()}`; break;
        case 'productSpecs': content = `<div><label class="${labelClass}">規格名稱</label><input name="name" class="${inputClass}" required></div>${categoryDropdown()}`; break;
        case 'productPackagings': content = `<div><label class="${labelClass}">包裝名稱</label><input name="name" class="${inputClass}" required></div>${categoryDropdown()}`; break;
        case 'supplierQuote': content = `<div><label class="${labelClass}">供應商</label><select name="supplierId" class="${inputClass}">${db.suppliers.map(s=>`<option value="${s.id}">${s.name}</option>`).join('')}</select></div><div><label class="${labelClass}">成本價</label><input name="cost" type="number" step="any" class="${inputClass}" required></div><div><label class="${labelClass}">報價時間</label><input name="date" type="datetime-local" value="${nowString}" class="${inputClass}" required></div><input type="hidden" name="productId" value="${productId}">`; break;
        case 'quoteToBuyer': content = `${!buyerId ? `<div><label class="${labelClass}">購買者</label><select name="buyerId" class="${inputClass}">${db.buyers.map(b=>`<option value="${b.id}">${b.name}</option>`).join('')}</select></div>` : `<input type="hidden" name="buyerId" value="${buyerId}">`}<div><label class="${labelClass}">出價</label><input name="price" type="number" step="any" class="${inputClass}" required></div><div><label class="${labelClass}">出價時間</label><input name="date" type="datetime-local" value="${nowString}" class="${inputClass}" required></div><input type="hidden" name="supplierQuoteId" value="${supplierQuoteId}">`; break;
        default: content = '表單未定義';
    }
    return content;
}

/**
 * 關閉 Modal
 */
function closeModal() {
    modalContainer.classList.add('hidden');
    document.body.classList.remove('modal-open');
    modalContainer.innerHTML = '';
}

// --- 6. 事件處理 (Event Handling & Logic) ---

/**
 * 處理 Modal 表單提交
 */
function handleFormSubmit(e) {
    e.preventDefault();
    const form = e.target;
    const type = form.dataset.type;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    // 將 datetime-local 的值轉換為 ISO String
    if (data.date) {
        data.date = new Date(data.date).toISOString();
    }

    const handlers = {
        suppliers: () => db.suppliers.push({ id: generateId('sup'), ...data }),
        buyers: () => db.buyers.push({ id: generateId('buy'), ...data }),
        products: () => db.products.push({ id: generateId('prod'), ...data }),
        productCategories: () => db.productCategories.push({ id: generateId('cat'), ...data }),
        productParts: () => db.productParts.push({ id: generateId('part'), ...data }),
        productSpecs: () => db.productSpecs.push({ id: generateId('spec'), ...data }),
        productPackagings: () => db.productPackagings.push({ id: generateId('pack'), ...data }),
        supplierQuote: () => db.supplierQuotes.push({ id: generateId('sq'), ...data, cost: parseFloat(data.cost) }),
        quoteToBuyer: () => db.quotesToBuyers.push({ id: generateId('qb'), ...data, price: parseFloat(data.price) }),
    };

    handlers[type] ? handlers[type]() : console.error('未知的表單類型:', type);
    closeModal();
    render(); // 重新渲染以顯示更新
}

/**
 * 使用事件委派處理所有點擊事件
 */
function handleGlobalClick(e) {
    const target = e.target.closest('[data-action]');
    if (!target) return;

    e.preventDefault();
    const { action, page, id, type, tab, productId, supplierQuoteId, buyerId } = target.dataset;

    switch (action) {
        case 'navigate':
            state.currentPage = page;
            state.selectedId = null;
            break;
        case 'view-detail':
            if (type === 'products') state.currentPage = 'productDetail';
            else if (type === 'buyers') state.currentPage = 'buyerDetail';
            else return; // 如果是供應商列表等，點擊無效
            state.selectedId = id;
            state.buyerDetailSelectedProductId = null;
            break;
        case 'show-add-modal':
            showModal(type, { productId, supplierQuoteId, buyerId });
            return; // 不需重新渲染
        case 'close-modal':
            closeModal();
            return; // 不需重新渲染
        case 'switch-attribute-tab':
            state.attributeTab = tab;
            break;
        case 'select-buyer-product':
            state.buyerDetailSelectedProductId = productId;
            break;
    }
    render();
}

/**
 * 綁定事件監聽器
 */
function addEventListeners() {
    // 移除舊監聽器以避免重複綁定
    appContainer.removeEventListener('click', handleGlobalClick);
    modalContainer.removeEventListener('click', handleGlobalClick);
    
    // 添加新監聽器
    appContainer.addEventListener('click', handleGlobalClick);
    modalContainer.addEventListener('click', handleGlobalClick);
    
    const modalForm = document.getElementById('modal-form');
    if (modalForm) {
        modalForm.addEventListener('submit', handleFormSubmit);
    }
    
    // 點擊 Modal 外部區域關閉
    const modalContent = document.getElementById('modal-content');
    if (modalContent) {
        modalContainer.addEventListener('click', (e) => {
            if (!modalContent.contains(e.target)) {
                closeModal();
            }
        });
    }
}


// --- 7. 初始化 ---
document.addEventListener('DOMContentLoaded', () => {
    state.currentPage = 'suppliers'; // 設置起始頁面
    render();
});
</script>
</body>
</html>