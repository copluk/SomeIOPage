<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>購買者詳情 - 內部貿易系統</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .slide-in-left { animation: slideInLeft 0.4s ease-in-out; }
        @keyframes slideInLeft { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }

        /* <details> 標籤的箭頭樣式 */
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details > summary::before {
            content: '\f0da'; /* Font Awesome right arrow */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            margin-right: 0.5rem;
            transition: transform 0.2s ease-in-out;
            display: inline-block;
        }
        details[open] > summary::before {
            transform: rotate(90deg);
        }

        /* 禁用按鈕的樣式 */
        button:disabled {
            cursor: not-allowed;
            background-color: #d1d5db; /* gray-300 */
        }
        button:disabled:hover {
            background-color: #d1d5db; /* gray-400 */
        }
        /* Modal 開啟時，禁止背景滾動 */
        body.modal-open {
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">

    <div id="app" class="flex h-screen">
        
        <nav class="w-64 bg-white shadow-lg flex-shrink-0 flex flex-col">
            <div class="p-4 border-b flex items-center gap-3">
                <i class="fas fa-chart-line text-3xl text-indigo-600"></i>
                <h1 class="text-xl font-bold text-gray-800">內部貿易系統</h1>
            </div>
            <ul class="flex-grow">
                <li><a href="./suppliers.html" data-page="suppliers" class="flex items-center gap-3 p-4 text-gray-600 hover:bg-indigo-50 hover:text-indigo-600 transition-colors duration-200"><i class="fas fa-truck w-5 text-center"></i><span>供應商管理</span></a></li>
                <li><a href="./buyers.html" data-page="buyers" class="flex items-center gap-3 p-4 text-gray-600 hover:bg-indigo-50 hover:text-indigo-600 transition-colors duration-200"><i class="fas fa-users w-5 text-center"></i><span>購買者管理</span></a></li>
                <li><a href="./products.html" data-page="products" class="flex items-center gap-3 p-4 text-gray-600 hover:bg-indigo-50 hover:text-indigo-600 transition-colors duration-200"><i class="fas fa-box-open w-5 text-center"></i><span>產品管理</span></a></li>
                <li><a href="./attributes.html" data-page="attributes" class="flex items-center gap-3 p-4 text-gray-600 hover:bg-indigo-50 hover:text-indigo-600 transition-colors duration-200"><i class="fas fa-tags w-5 text-center"></i><span>產品屬性管理</span></a></li>
                <li><a href="./orders.html" data-page="orders" class="flex items-center gap-3 p-4 text-gray-600 hover:bg-indigo-50 hover:text-indigo-600 transition-colors duration-200"><i class="fas fa-file-invoice-dollar w-5 text-center"></i><span>訂單管理</span></a></li>
            </ul>
        </nav>

        <main id="page-content" class="flex-1 p-6 md:p-8 overflow-y-auto bg-gray-50">
            <div class="text-center text-gray-500">正在載入資料...</div>
        </main>
    </div>

    <div id="modal-container" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4 fade-in">
        </div>


    <script>
    // --- 資料模型 (Data Model) ---
    const db = {
         Users: [ { UserID: 1, Username: "sales_lin", PasswordHash: "hashed_password_1", FullName: "林業務", Email: "lin@example.com", AccountStatus: "Active", RoleID: 2, SystemCreatedAt: "2024-01-10T09:00:00Z", SystemUpdatedAt: "2025-06-12T14:30:00Z" }, { UserID: 2, Username: "manager_chen", PasswordHash: "hashed_password_2", FullName: "陳經理", Email: "chen@example.com", AccountStatus: "Active", RoleID: 1, SystemCreatedAt: "2024-01-10T09:00:00Z", SystemUpdatedAt: "2025-06-12T14:30:00Z" } ],
         Roles: [ { RoleID: 1, RoleName: "管理者" }, { RoleID: 2, RoleName: "業務" } ],
         Suppliers: [ { SupplierID: 1, SupplierName: "環球肉品公司", ContactPersonName: "王經理", ContactPersonEmail: "wang@worldmeat.com", ContactPersonPhone: "02-2788-1234", PaymentTerms: "月結30天", WebsiteURL: "https://www.worldmeat.com", Remarks: "每週一、四固定出貨。" }, { SupplierID: 2, SupplierName: "頂級海鮮直送", ContactPersonName: "李小姐", ContactPersonEmail: "lee@topseafood.com", ContactPersonPhone: "07-555-8888", PaymentTerms: "貨到付款", WebsiteURL: "https://www.topseafood.com", Remarks: "需提前三天預訂特殊品項。" } ],
         Buyers: [ { BuyerID: 101, BuyerName: "A級牛排館", AssignedSalespersonUserID: 1, ContactPersonName: "陳主廚", ContactPersonEmail: "chen.chef@asteak.com", ContactPersonPhone: "0912-345-678", PaymentTerms: "月結60天", WebsiteURL: null, Remarks: "偏好油花較少的部位。" }, { BuyerID: 102, BuyerName: "饗食天堂餐飲集團", AssignedSalespersonUserID: 2, ContactPersonName: "採購部林先生", ContactPersonEmail: "procurement.lin@eat-together.com", ContactPersonPhone: "02-8780-8000", PaymentTerms: "月結45天", WebsiteURL: "https://www.eat-together.com", Remarks: "集團統一採購，需附檢驗報告。" } ],
         Product_Categories: [ { CategoryID: 1, PartName_ZH: "牛肉", PartName_EN: "Beef", IsActive: true }, { CategoryID: 2, PartName_ZH: "豬肉", PartName_EN: "Pork", IsActive: true }, { CategoryID: 3, PartName_ZH: "海鮮", PartName_EN: "Seafood", IsActive: true } ],
         Product_Parts: [ { PartID: 1, CategoryID: 1, PartName_ZH: "肋眼", PartName_EN: "Ribeye", IsActive: true }, { PartID: 2, CategoryID: 1, PartName_ZH: "菲力", PartName_EN: "Tenderloin", IsActive: true }, { PartID: 3, CategoryID: 2, PartName_ZH: "梅花", PartName_EN: "Pork Collar", IsActive: true }, { PartID: 4, CategoryID: 2, PartName_ZH: "五花", PartName_EN: "Pork Belly", IsActive: true }, { PartID: 5, CategoryID: 3, PartName_ZH: "龍蝦", PartName_EN: "Lobster", IsActive: true }, { PartID: 6, CategoryID: 3, PartName_ZH: "干貝", PartName_EN: "Scallop", IsActive: true }, { PartID: 7, CategoryID: 3, PartName_ZH: "鮭魚", PartName_EN: "Salmon", IsActive: true } ],
         Product_Specs: [ { SpecID: 1, CategoryID: 1, SpecName_ZH: "M9", SpecName_EN: "M9 Grade", IsActive: true }, { SpecID: 2, CategoryID: 2, SpecName_ZH: "Bellota", SpecName_EN: "Bellota Grade", IsActive: true }, { SpecID: 3, CategoryID: 2, SpecName_ZH: "活菌飼養", SpecName_EN: "Probiotic-fed", IsActive: true }, { SpecID: 4, CategoryID: 3, SpecName_ZH: "野生", SpecName_EN: "Wild Caught", IsActive: true }, { SpecID: 5, CategoryID: 3, SpecName_ZH: "生食級", SpecName_EN: "Sashimi Grade", IsActive: true }, { SpecID: 6, CategoryID: 3, SpecName_ZH: "輪切", SpecName_EN: "Wheel Cut", IsActive: true } ],
         Product_Packagings: [ { PackagingID: 1, CategoryID: 1, PackagingName_ZH: "真空包裝", PackagingName_EN: "Vacuum Packed", IsActive: true }, { PackagingID: 2, CategoryID: 1, PackagingName_ZH: "原塊", PackagingName_EN: "Whole Piece", IsActive: true }, { PackagingID: 3, CategoryID: 1, PackagingName_ZH: "禮盒裝", PackagingName_EN: "Gift Box", IsActive: true }, { PackagingID: 4, CategoryID: 2, PackagingName_ZH: "真空包裝", PackagingName_EN: "Vacuum Packed", IsActive: true }, { PackagingID: 5, CategoryID: 2, PackagingName_ZH: "原塊", PackagingName_EN: "Whole Piece", IsActive: true }, { PackagingID: 6, CategoryID: 3, PackagingName_ZH: "真空包裝", PackagingName_EN: "Vacuum Packed", IsActive: true }, { PackagingID: 7, CategoryID: 3, PackagingName_ZH: "禮盒裝", PackagingName_EN: "Gift Box", IsActive: true } ],
         Products: [ { ProductID: 1, SupplierID: 1, CategoryID: 1, PartID: 1, SpecID: 1, PackagingID: 2, ProductDisplayName: "澳洲和牛M9肋眼", ProductCode: "AW-RB-G9-001" }, { ProductID: 2, SupplierID: 1, CategoryID: 2, PartID: 3, SpecID: 2, PackagingID: 4, ProductDisplayName: "西班牙伊比利豬梅花", ProductCode: "SP-Pork-001" }, { ProductID: 3, SupplierID: 1, CategoryID: 2, PartID: 4, SpecID: 3, PackagingID: 4, ProductDisplayName: "台灣活菌豬五花", ProductCode: "TW-Pork-005" }, { ProductID: 4, SupplierID: 2, CategoryID: 3, PartID: 5, SpecID: 4, PackagingID: 7, ProductDisplayName: "波士頓龍蝦", ProductCode: "SEA-LOB-01" }, { ProductID: 5, SupplierID: 2, CategoryID: 3, PartID: 6, SpecID: 5, PackagingID: 6, ProductDisplayName: "北海道干貝", ProductCode: "SEA-SCA-03" }, { ProductID: 6, SupplierID: 2, CategoryID: 3, PartID: 7, SpecID: 6, PackagingID: 6, ProductDisplayName: "智利鮭魚", ProductCode: "SEA-SAL-02" } ], 
         Supplier_Quotes: [ { SupplierQuoteID: 1, ProductID: 1, EffectiveTimestamp: "2025-05-20T00:00:00Z", SupplierOriginalPrice: 1800, InternalCostPrice: 1850 }, { SupplierQuoteID: 2, ProductID: 1, EffectiveTimestamp: "2025-06-01T00:00:00Z", SupplierOriginalPrice: 1820, InternalCostPrice: 1870 }, { SupplierQuoteID: 3, ProductID: 1, EffectiveTimestamp: "2025-06-10T00:00:00Z", SupplierOriginalPrice: 1810, InternalCostPrice: 1860 }, { SupplierQuoteID: 4, ProductID: 2, EffectiveTimestamp: "2025-06-01T00:00:00Z", SupplierOriginalPrice: 800, InternalCostPrice: 850 }, { SupplierQuoteID: 5, ProductID: 2, EffectiveTimestamp: "2025-06-05T00:00:00Z", SupplierOriginalPrice: 810, InternalCostPrice: 860 }, { SupplierQuoteID: 6, ProductID: 2, EffectiveTimestamp: "2025-06-08T00:00:00Z", SupplierOriginalPrice: 805, InternalCostPrice: 855 }, { SupplierQuoteID: 7, ProductID: 3, EffectiveTimestamp: "2025-06-02T00:00:00Z", SupplierOriginalPrice: 400, InternalCostPrice: 430 }, { SupplierQuoteID: 8, ProductID: 3, EffectiveTimestamp: "2025-06-06T00:00:00Z", SupplierOriginalPrice: 410, InternalCostPrice: 440 }, { SupplierQuoteID: 9, ProductID: 3, EffectiveTimestamp: "2025-06-09T00:00:00Z", SupplierOriginalPrice: 405, InternalCostPrice: 435 }, { SupplierQuoteID: 10, ProductID: 4, EffectiveTimestamp: "2025-06-03T00:00:00Z", SupplierOriginalPrice: 1200, InternalCostPrice: 1250 }, { SupplierQuoteID: 11, ProductID: 4, EffectiveTimestamp: "2025-06-07T00:00:00Z", SupplierOriginalPrice: 1220, InternalCostPrice: 1270 }, { SupplierQuoteID: 12, ProductID: 4, EffectiveTimestamp: "2025-06-11T00:00:00Z", SupplierOriginalPrice: 1180, InternalCostPrice: 1230 }, { SupplierQuoteID: 13, ProductID: 5, EffectiveTimestamp: "2025-06-04T00:00:00Z", SupplierOriginalPrice: 900, InternalCostPrice: 940 }, { SupplierQuoteID: 14, ProductID: 5, EffectiveTimestamp: "2025-06-08T00:00:00Z", SupplierOriginalPrice: 910, InternalCostPrice: 950 }, { SupplierQuoteID: 15, ProductID: 5, EffectiveTimestamp: "2025-06-12T00:00:00Z", SupplierOriginalPrice: 890, InternalCostPrice: 930 }, { SupplierQuoteID: 16, ProductID: 6, EffectiveTimestamp: "2025-06-05T00:00:00Z", SupplierOriginalPrice: 700, InternalCostPrice: 740 }, { SupplierQuoteID: 17, ProductID: 6, EffectiveTimestamp: "2025-06-09T00:00:00Z", SupplierOriginalPrice: 710, InternalCostPrice: 750 }, { SupplierQuoteID: 18, ProductID: 6, EffectiveTimestamp: "2025-06-13T00:00:00Z", SupplierOriginalPrice: 690, InternalCostPrice: 730 } ],
         Quotes_To_Buyers: [ { QuoteToBuyerID: 1, SupplierQuoteID: 3, ProductID: 1, BuyerID: 101, QuotedPrice: 2200, CustomerExpectedPrice: null, QuoteTimestamp: "2025-06-11T10:00:00Z", Status: "Negotiating", CreatedByUserID: 1 }, { QuoteToBuyerID: 2, SupplierQuoteID: 3, ProductID: 1, BuyerID: 101, QuotedPrice: null, CustomerExpectedPrice: 2150, QuoteTimestamp: "2025-06-11T11:00:00Z", Status: "Negotiating", CreatedByUserID: 1 }, { QuoteToBuyerID: 3, SupplierQuoteID: 3, ProductID: 1, BuyerID: 102, QuotedPrice: 2250, CustomerExpectedPrice: null, QuoteTimestamp: "2025-06-12T09:30:00Z", Status: "Negotiating", CreatedByUserID: 2 }, { QuoteToBuyerID: 4, SupplierQuoteID: 6, ProductID: 2, BuyerID: 101, QuotedPrice: 1000, CustomerExpectedPrice: null, QuoteTimestamp: "2025-06-09T14:00:00Z", Status: "Accepted", CreatedByUserID: 1 }, { QuoteToBuyerID: 5, SupplierQuoteID: 9, ProductID: 3, BuyerID: 101, QuotedPrice: 550, CustomerExpectedPrice: null, QuoteTimestamp: "2025-06-10T11:00:00Z", Status: "Accepted", CreatedByUserID: 1 }, { QuoteToBuyerID: 6, SupplierQuoteID: 12, ProductID: 4, BuyerID: 101, QuotedPrice: 1400, CustomerExpectedPrice: null, QuoteTimestamp: "2025-06-12T15:00:00Z", Status: "Accepted", CreatedByUserID: 1 }, { QuoteToBuyerID: 7, SupplierQuoteID: 15, ProductID: 5, BuyerID: 102, QuotedPrice: 1100, CustomerExpectedPrice: null, QuoteTimestamp: "2025-06-13T09:00:00Z", Status: "Accepted", CreatedByUserID: 2 }, { QuoteToBuyerID: 8, SupplierQuoteID: 18, ProductID: 6, BuyerID: 102, QuotedPrice: 850, CustomerExpectedPrice: null, QuoteTimestamp: "2025-06-13T09:05:00Z", Status: "Accepted", CreatedByUserID: 2 } ],
         Orders: [ { OrderID: 1, OrderNumber: "ORD-202506-001", BuyerID: 102, SupplierID: 2, LoadingTimestamp: "2025-07-15T00:00:00Z", ArrivalTimestamp: "2025-08-20T00:00:00Z", PaymentMethod: "T/T 30 days", OrderStatus: "Confirmed", CreatedByUserID: 2, SystemCreatedAt: "2025-06-13T10:00:00Z" } ],
         Order_Line_Items: [ { LineItemID: 1, OrderID: 1, QuoteToBuyerID: 7, ProductID: 5, Weight: 500.5 }, { LineItemID: 2, OrderID: 1, QuoteToBuyerID: 8, ProductID: 6, Weight: 800.0 } ]
    };
    
    // --- 共用輔助函式 (Helper Functions) ---
    const formatDateTime = (iso) => iso ? new Date(iso).toLocaleString('zh-TW', { timeZone: "Asia/Taipei", year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false }).replace(/,/g, '') : 'N/A';
    const findById = (collectionName, id, keyName) => db[collectionName].find(item => item[keyName] === id);
    const getStatusBadge = (status) => {
        const styles = { Negotiating: 'bg-yellow-100 text-yellow-800', Accepted: 'bg-green-100 text-green-800', Rejected: 'bg-red-100 text-red-800', Ordered: 'bg-blue-100 text-blue-800', Confirmed: 'bg-sky-100 text-sky-800' };
        return `<span class="px-2 py-1 text-xs font-medium rounded-full whitespace-nowrap ${styles[status] || 'bg-gray-100 text-gray-800'}">${status}</span>`;
    };
    const highlightCurrentNav = () => {
        const currentPage = 'buyers';
        const activeLink = document.querySelector(`a[data-page="${currentPage}"]`);
        if (activeLink) {
            activeLink.classList.add('bg-indigo-50', 'text-indigo-600', 'font-bold', 'border-l-4', 'border-indigo-600');
        }
    };

    // --- buyer-detail.html 頁面專屬的 JavaScript 邏輯 ---
    const pageState = {
        activeTab: 'quote',
        selectedProductId: null,
        selectedSupplierIdForOrder: null, 
        checkedQuoteIds: new Set(),
    };

    // --- NEW: Modal Functions ---
    const modalContainer = document.getElementById('modal-container');
    function showModal(title, content) {
        modalContainer.innerHTML = `<div class="bg-white rounded-lg shadow-xl w-full max-w-lg m-auto"><div class="flex justify-between items-center p-5 border-b"><h3 class="text-xl font-bold">${title}</h3><button data-action="close-modal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button></div><div class="p-6">${content}</div><div class="flex justify-end p-4 bg-gray-50 border-t"><button data-action="close-modal" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg mr-2 hover:bg-gray-300">取消</button><button data-action="close-modal" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">儲存 (展示)</button></div></div>`;
        modalContainer.classList.remove('hidden');
        document.body.classList.add('modal-open');
    }
    function closeModal() {
        if(modalContainer) {
            modalContainer.classList.add('hidden');
            document.body.classList.remove('modal-open');
        }
    }
    function getModalContent(type) {
        const inputClass = "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm";
        const labelClass = "block text-sm font-medium text-gray-700";
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        const nowString = now.toISOString().slice(0,16);
        if (type === 'pre-close') {
            return `<div class="space-y-4"><div><label class="${labelClass}">最終成交價</label><input type="number" class="${inputClass}" placeholder="e.g., 2180"></div><div><label class="${labelClass}">最終購買價 (最終成本)</label><input type="number" class="${inputClass}" placeholder="e.g., 1860"></div><div><label class="${labelClass}">交易時間</label><input type="datetime-local" value="${nowString}" class="${inputClass}"></div></div>`;
        }
        return '';
    }
    // --- End Modal Functions ---


    function renderPage(buyerId) {
        const pageContent = document.getElementById('page-content');
        const buyer = findById('Buyers', buyerId, 'BuyerID');
        if (!buyer) { pageContent.innerHTML = `<div class="text-center text-red-500 font-bold">錯誤：找不到 ID 為 ${buyerId} 的購買者。</div>`; return; }
        const tabs = [{ key: 'quote', name: '報價與議價' }, { key: 'pendingOrders', name: '待確認訂單' }, { key: 'history', name: '歷史出價列表' }];
        pageContent.innerHTML = `<div class="fade-in"><div class="mb-6 bg-white p-6 rounded-lg shadow"><div class="flex justify-between items-start"><div><h2 class="text-3xl font-bold text-gray-900">${buyer.BuyerName}</h2><p class="text-gray-500 mt-1">負責業務: ${findById('Users', buyer.AssignedSalespersonUserID, 'UserID')?.FullName}</p></div><button class="text-gray-500 hover:text-gray-800 font-semibold text-sm">編輯基本資料</button></div><div class="mt-4 pt-4 border-t grid grid-cols-2 md:grid-cols-4 gap-4 text-sm"><div><strong class="block text-gray-500">主要聯絡人</strong> ${buyer.ContactPersonName}</div><div><strong class="block text-gray-500">聯絡人Email</strong> ${buyer.ContactPersonEmail}</div><div><strong class="block text-gray-500">聯絡人電話</strong> ${buyer.ContactPersonPhone}</div><div><strong class="block text-gray-500">付款條件</strong> ${buyer.PaymentTerms}</div><div class="col-span-full"><strong class="block text-gray-500">備註</strong> ${buyer.Remarks}</div></div></div><div class="border-b border-gray-200"><nav id="tab-nav" class="-mb-px flex space-x-8">${tabs.map(t => `<button data-action="switch-tab" data-tab="${t.key}" class="py-4 px-1 border-b-2 font-medium text-sm ${pageState.activeTab === t.key ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}">${t.name}</button>`).join('')}</nav></div><div id="tab-content" class="mt-6">${renderTabContent(buyer)}</div></div>`;
    }

    function renderTabContent(buyer) {
        switch (pageState.activeTab) {
            case 'quote': return renderQuoteTab(buyer);
            case 'pendingOrders': return renderPendingOrdersTab(buyer);
            case 'history': return renderHistoryTab(buyer);
            default: return `<div>頁籤內容錯誤</div>`;
        }
    }

    // *** MODIFIED FUNCTION with Pre-close Button Logic ***
    function renderQuoteTab(buyer) {
        const productIds = [...new Set(db.Quotes_To_Buyers.filter(q => q.BuyerID === buyer.BuyerID).map(q => q.ProductID))];
        const products = db.Products.filter(p => productIds.includes(p.ProductID));
        let rightPanelHtml = `<div class="text-center text-gray-500 h-full flex items-center justify-center">請從左側選擇一個產品查看議價詳情。</div>`;
        if (pageState.selectedProductId) {
            const selectedProduct = findById('Products', pageState.selectedProductId, 'ProductID');
            const latestSq = db.Supplier_Quotes.filter(sq => sq.ProductID === selectedProduct.ProductID).sort((a,b) => new Date(b.EffectiveTimestamp) - new Date(a.EffectiveTimestamp))[0];
            const quotesForLatestSq = latestSq ? db.Quotes_To_Buyers.filter(qtb => qtb.SupplierQuoteID === latestSq.SupplierQuoteID && qtb.BuyerID === buyer.BuyerID) : [];
            const latestBuyerQuoteInPeriod = quotesForLatestSq.length > 0 ? [...quotesForLatestSq].sort((a, b) => new Date(b.QuoteTimestamp) - new Date(a.QuoteTimestamp))[0] : null;

            rightPanelHtml = `<div class="flex justify-between items-center"><h3 class="text-xl font-bold mb-4 text-gray-800">議價詳情: ${selectedProduct.ProductDisplayName}</h3><div class="space-x-2"><button class="bg-blue-500 text-white text-xs font-bold py-1 px-3 rounded-md hover:bg-blue-600">新增我方出價</button><button class="bg-green-500 text-white text-xs font-bold py-1 px-3 rounded-md hover:bg-green-600">記錄客戶出價</button></div></div>
                ${latestSq ? `<div class="bg-gray-50 p-4 rounded-lg mb-4 border"><h4 class="font-semibold text-gray-600">最新時段報價資訊 (於 ${formatDateTime(latestSq.EffectiveTimestamp)})</h4><div class="flex gap-8 mt-2"><div><span class="text-sm">內部成本價:</span> <strong class="text-red-600">$${latestSq.InternalCostPrice}</strong></div><div><span class="text-sm">供應商原始價:</span> <strong>$${latestSq.SupplierOriginalPrice}</strong></div></div></div><h4 class="font-semibold mb-2 text-gray-700">出價列表</h4>
                <table class="min-w-full text-sm"><thead class="bg-gray-100"><tr><th class="p-2 text-left">我方業務出價</th><th class="p-2 text-left">客戶預期價格</th><th class="p-2 text-left">報價時間</th><th class="p-2 text-left">狀態</th><th class="p-2 text-left">操作</th></tr></thead>
                <tbody class="divide-y divide-gray-200">${quotesForLatestSq.map(q => {
                    const actionButtonHtml = (latestBuyerQuoteInPeriod && q.QuoteToBuyerID === latestBuyerQuoteInPeriod.QuoteToBuyerID)
                        ? `<button data-action="show-pre-close-modal" class="bg-teal-500 text-white text-xs font-bold py-1 px-2 rounded hover:bg-teal-600">預定成交</button>` : '';
                    return `<tr><td class="p-2 font-bold text-blue-700">$${q.QuotedPrice || '-'}</td><td class="p-2 font-bold text-green-700">$${q.CustomerExpectedPrice || '-'}</td><td class="p-2">${formatDateTime(q.QuoteTimestamp)}</td><td class="p-2">${getStatusBadge(q.Status)}</td><td class="p-2">${actionButtonHtml}</td></tr>`
                }).join('') || `<tr><td colspan="5" class="p-4 text-center text-gray-400">此時段尚無出價紀錄</td></tr>`}</tbody></table>` : `<p>此產品無供應商報價資訊。</p>`}`;
        }
        return `<div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div id="product-list-panel" class="md:col-span-1 bg-white p-4 rounded-lg shadow-sm h-fit"><h3 class="font-bold border-b pb-2 mb-2 text-gray-700">購買者出價過的產品列表</h3><ul class="space-y-1">${products.map(p => `<li data-action="select-product" data-id="${p.ProductID}" class="p-2 rounded cursor-pointer ${p.ProductID === pageState.selectedProductId ? 'bg-indigo-100 font-bold text-indigo-700' : 'hover:bg-gray-100'}">${p.ProductDisplayName}</li>`).join('')}</ul></div><div class="md:col-span-2 bg-white p-6 rounded-lg shadow-sm slide-in-left min-h-[300px]">${rightPanelHtml}</div></div>`;
    }

    function renderPendingOrdersTab(buyer) {
        const acceptedQuotes = db.Quotes_To_Buyers.filter(q => q.BuyerID === buyer.BuyerID && q.Status === 'Accepted');
        const tableRowsHtml = acceptedQuotes.map(q => {
            const product = findById('Products', q.ProductID, 'ProductID');
            const supplier = findById('Suppliers', product.SupplierID, 'SupplierID');
            const sq = findById('Supplier_Quotes', q.SupplierQuoteID, 'SupplierQuoteID');
            const isEnabled = !pageState.selectedSupplierIdForOrder || pageState.selectedSupplierIdForOrder === product.SupplierID;
            const isChecked = pageState.checkedQuoteIds.has(q.QuoteToBuyerID);
            return `<tr class="${isEnabled ? 'hover:bg-gray-50' : 'opacity-50 bg-gray-100 text-gray-400'}"><td class="p-3"><input type="checkbox" data-action="toggle-order-item" data-supplier-id="${product.SupplierID}" data-quote-id="${q.QuoteToBuyerID}" ${isEnabled ? '' : 'disabled'} ${isChecked ? 'checked' : ''}></td><td class="p-3">${product?.ProductDisplayName || 'N/A'}</td><td class="p-3">${supplier?.SupplierName || 'N/A'}</td><td class="p-3 ${isEnabled ? 'text-red-600 font-medium' : ''}">$${sq?.InternalCostPrice}</td><td class="p-3 ${isEnabled ? 'font-bold' : ''}">$${q.QuotedPrice || q.CustomerExpectedPrice}</td><td class="p-3">${formatDateTime(q.QuoteTimestamp)}</td><td class="p-3"><input type="number" class="w-24 p-1 border rounded-md" ${isEnabled ? '' : 'disabled'}></td></tr>`
        }).join('');
        return `<div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-xl font-bold text-gray-800 mb-2">第一步：勾選已接受的報價</h3><p class="text-sm text-gray-500 mb-4">請勾選來自<strong class="text-indigo-600">同一個供應商</strong>的產品，以合併為訂單。</p>${acceptedQuotes.length > 0 ? `<div class="overflow-x-auto border rounded-lg"><table class="min-w-full text-sm"><thead class="bg-gray-100"><tr><th class="p-3 text-left w-10"><input type="checkbox" disabled></th><th class="p-3 text-left">產品名稱</th><th class="p-3 text-left">供應商</th><th class="p-3 text-left">最終成本價</th><th class="p-3 text-left">最終成交價</th><th class="p-3 text-left">報價時間</th><th class="p-3 text-left">重量 (kg)</th></tr></thead><tbody id="pending-order-tbody" class="divide-y divide-gray-200">${tableRowsHtml}</tbody></table></div>` : `<p class="text-gray-500 text-center py-8">目前沒有已接受的報價。</p>`}<div class="mt-8 pt-6 border-t"><h3 class="text-xl font-bold text-gray-800 mb-4">第二步：填寫訂單共用資訊</h3><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div><label for="loading-time" class="block text-sm font-medium text-gray-700">裝櫃時間</label><input type="datetime-local" id="loading-time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></div><div><label for="eta-time" class="block text-sm font-medium text-gray-700">預計到貨時間</label><input type="datetime-local" id="eta-time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></div><div><label for="payment-method" class="block text-sm font-medium text-gray-700">支付方式</label><input type="text" id="payment-method" value="${buyer.PaymentTerms}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></div></div></div><div class="mt-8 pt-6 text-right"><button id="create-order-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition duration-200" ${!pageState.selectedSupplierIdForOrder ? 'disabled' : ''}>第三步：成立訂單</button></div></div>`;
    }

    function renderHistoryTab(buyer) {
        const allQuotesForBuyer = db.Quotes_To_Buyers.filter(q => q.BuyerID === buyer.BuyerID);
        const productIdsHistory = [...new Set(allQuotesForBuyer.map(q => q.ProductID))];
        const productsHistory = db.Products.filter(p => productIdsHistory.includes(p.ProductID));
        return `<div class="bg-white p-6 rounded-lg shadow-md space-y-4"><h3 class="text-xl font-bold mb-2 text-gray-800">完整歷史出價列表</h3>${productsHistory.map(p => `<details class="bg-gray-50 rounded-lg border hover:bg-gray-100 transition"><summary class="p-4 font-semibold cursor-pointer">${p.ProductDisplayName}</summary><div class="p-4 border-t bg-white overflow-x-auto"><table class="min-w-full text-sm"><thead class="bg-gray-100"><tr><th class="p-2 text-left">供應商報價時段</th><th class="p-2 text-left">當時供應商報價</th><th class="p-2 text-left">當時我方成本</th><th class="p-2 text-left">我方業務報價</th><th class="p-2 text-left">購買者預期價格</th><th class="p-2 text-left">出價時間</th><th class="p-2 text-left">最終狀態</th><th class="p-2 text-left">成交資訊</th></tr></thead><tbody class="divide-y divide-gray-200">${allQuotesForBuyer.filter(q => q.ProductID === p.ProductID).sort((a,b) => new Date(b.QuoteTimestamp) - new Date(a.QuoteTimestamp)).map(q => { const sq = findById('Supplier_Quotes', q.SupplierQuoteID, 'SupplierQuoteID'); let orderInfo = ''; if(q.Status === 'Ordered') { const lineItem = db.Order_Line_Items.find(li => li.QuoteToBuyerID === q.QuoteToBuyerID); const order = findById('Orders', lineItem?.OrderID, 'OrderID'); const finalPrice = q.QuotedPrice || q.CustomerExpectedPrice; orderInfo = `<div class="text-xs text-blue-600">訂單: ${order?.OrderNumber}<br>成交價: $${finalPrice}<br>成本價: $${sq.InternalCostPrice}<br>訂單時間: ${formatDateTime(order?.SystemCreatedAt)}</div>`; } return `<tr><td class="p-2">${formatDateTime(sq.EffectiveTimestamp)}</td><td class="p-2">$${sq.SupplierOriginalPrice}</td><td class="p-2 text-red-600">$${sq.InternalCostPrice}</td><td class="p-2">$${q.QuotedPrice || '-'}</td><td class="p-2">$${q.CustomerExpectedPrice || '-'}</td><td class="p-2">${formatDateTime(q.QuoteTimestamp)}</td><td class="p-2">${getStatusBadge(q.Status)}</td><td class="p-2">${orderInfo || '-'}</td></tr>`}).join('')}</tbody></table></div></details>`).join('')}</div>`;
    }

    function updatePendingOrderView() {
        const tbody = document.getElementById('pending-order-tbody');
        if (!tbody) return;
        const rows = tbody.querySelectorAll('tr');
        rows.forEach(row => {
            const checkbox = row.querySelector('input[type="checkbox"]');
            const otherInputs = row.querySelectorAll('input[type="number"]');
            if (!checkbox) return;
            const supplierId = parseInt(checkbox.dataset.supplierId);
            const isEnabled = !pageState.selectedSupplierIdForOrder || pageState.selectedSupplierIdForOrder === supplierId;
            checkbox.disabled = !isEnabled;
            otherInputs.forEach(input => input.disabled = !isEnabled);
            if (isEnabled) { row.classList.remove('opacity-50', 'bg-gray-100', 'text-gray-400'); row.classList.add('hover:bg-gray-50'); } 
            else { row.classList.add('opacity-50', 'bg-gray-100', 'text-gray-400'); row.classList.remove('hover:bg-gray-50'); }
        });
        const createOrderBtn = document.getElementById('create-order-btn');
        if (createOrderBtn) { createOrderBtn.disabled = !pageState.selectedSupplierIdForOrder; }
    }

    function handlePageEvents() {
        const pageContent = document.getElementById('page-content');
        pageContent.addEventListener('click', (e) => {
            const target = e.target.closest('[data-action]');
            if (!target) return;
            const { action, tab, id } = target.dataset;
            const urlParams = new URLSearchParams(window.location.search);
            const buyerId = parseInt(urlParams.get('id'));

            if (action === 'switch-tab') {
                pageState.activeTab = tab;
                pageState.checkedQuoteIds.clear(); pageState.selectedSupplierIdForOrder = null;
                renderPage(buyerId);
            } else if (action === 'select-product') {
                pageState.selectedProductId = parseInt(id);
                renderPage(buyerId);
            } else if (action === 'show-pre-close-modal') {
                showModal('預定成交', getModalContent('pre-close'));
            }
        });
        pageContent.addEventListener('change', (e) => {
            const target = e.target.closest('[data-action="toggle-order-item"]');
            if (target) {
                const quoteId = parseInt(target.dataset.quoteId);
                if (target.checked) { pageState.checkedQuoteIds.add(quoteId); } 
                else { pageState.checkedQuoteIds.delete(quoteId); }
                if (pageState.checkedQuoteIds.size > 0) {
                    const firstCheckedQuote = findById('Quotes_To_Buyers', [...pageState.checkedQuoteIds][0], 'QuoteToBuyerID');
                    const firstProduct = findById('Products', firstCheckedQuote.ProductID, 'ProductID');
                    pageState.selectedSupplierIdForOrder = firstProduct.SupplierID;
                } else {
                    pageState.selectedSupplierIdForOrder = null;
                }
                updatePendingOrderView();
            }
        });

        // Add modal close listener
        modalContainer.addEventListener('click', (e) => {
            if (e.target.id === 'modal-container' || e.target.closest('[data-action="close-modal"]')) {
                closeModal();
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        highlightCurrentNav();
        const urlParams = new URLSearchParams(window.location.search);
        const buyerId = parseInt(urlParams.get('id'));
        const initialTab = urlParams.get('tab');
        if (initialTab) { pageState.activeTab = initialTab; }
        if (buyerId) { renderPage(buyerId); handlePageEvents(); } 
        else { document.getElementById('page-content').innerHTML = `<div class="text-center text-red-500 font-bold">錯誤：URL 中缺少購買者 ID。</div>`; }
    });
    
    </script>
</body>
</html>